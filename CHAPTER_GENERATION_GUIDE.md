# 分章節生成功能 - 實作說明

## 功能概述

現在系統會：
1. **生成結構化的JSON大綱**，包含多個章節
2. **逐章節調用AI生成內容**，而不是一次性生成全部內容
3. **實時顯示生成進度**，讓用戶了解當前進度

## 實現的功能

### 1. 後端改動

#### `backend/groq_service.py`
- ✅ `generate_outline()` - 返回JSON格式的結構化大綱
  - 包含 `title`（單元標題）
  - 包含 `objectives`（學習目標列表）
  - 包含 `chapters`（章節列表）
    - 每個章節有：`chapter_number`, `title`, `topics`, `description`

- ✅ `generate_chapter_content()` - 新增方法，為單個章節生成內容
  - 接收章節編號、標題、主題列表
  - 針對該章節生成500-800字的詳細內容

- ✅ `generate_content()` - 改為逐章節生成
  - 解析JSON大綱
  - 循環遍歷每個章節
  - 逐個調用AI生成章節內容
  - 支持進度回調函數
  - 如果JSON解析失敗，自動回退到備用方法

#### `backend/main.py`
- ✅ 添加全局進度追蹤字典 `generation_progress`
- ✅ 修改 `generate_content()` API
  - 初始化進度信息
  - 傳遞進度回調給服務層
  - 更新進度狀態
- ✅ 新增 `GET /api/generation-progress/{generation_id}` API
  - 返回當前生成進度
  - 包含：current（當前章節）, total（總章節數）, status（狀態）

### 2. 前端改動

#### `frontend/src/components/OutlineDisplay.jsx`
- ✅ 自動解析JSON格式的大綱
- ✅ 以美觀的卡片形式顯示：
  - 單元標題
  - 學習目標（帶編號的列表）
  - 章節列表（卡片式布局）
    - 章節編號、標題、描述
    - 主題標籤
- ✅ 顯示章節總數提示
- ✅ 仍支持編輯模式（JSON格式）

#### `frontend/src/components/ProgressIndicator.jsx` (新增)
- ✅ 顯示生成進度條
- ✅ 顯示當前/總章節數和百分比
- ✅ 章節列表狀態指示：
  - ✅ 已完成（綠色打勾）
  - 🔄 生成中（藍色旋轉圖標）
  - ⭕ 待處理（灰色編號）

#### `frontend/src/App.jsx`
- ✅ 添加 `progress` 狀態
- ✅ 使用 `useEffect` 輪詢進度（每秒）
- ✅ 在生成教材時顯示 `ProgressIndicator`
- ✅ 完成或錯誤時停止輪詢

#### `frontend/src/services/api.js`
- ✅ 新增 `getGenerationProgress()` 方法

## 工作流程

```
用戶輸入 → 生成大綱（JSON格式）
         ↓
    顯示結構化大綱
    （標題、目標、章節卡片）
         ↓
    用戶確認 → 開始逐章生成
         ↓
    章節1 → AI生成 → 更新進度 (1/5)
         ↓
    章節2 → AI生成 → 更新進度 (2/5)
         ↓
    章節3 → AI生成 → 更新進度 (3/5)
         ↓
        ...
         ↓
    全部完成 → 顯示完整教材
```

## 示例

### 大綱JSON格式
```json
{
  "title": "分數基礎概念",
  "objectives": [
    "認識分數的意義和表示方法",
    "理解分數的大小比較",
    "學會簡單的分數運算"
  ],
  "chapters": [
    {
      "chapter_number": 1,
      "title": "認識分數",
      "topics": ["什麼是分數", "分數的組成", "生活中的分數"],
      "description": "介紹分數的基本概念和日常應用"
    },
    {
      "chapter_number": 2,
      "title": "分數的表示",
      "topics": ["分數圖示", "數線上的分數", "等值分數"],
      "description": "學習如何用不同方式表示分數"
    }
  ]
}
```

### 生成過程
- 如果有5個章節，AI會被調用5次
- 每次生成一個章節的內容（500-800字）
- 前端實時顯示進度：1/5 → 2/5 → 3/5 → 4/5 → 5/5
- 全部完成後合併為完整教材

## 優勢

1. **更詳細的內容**：每個章節獨立生成，可以更深入
2. **更好的結構**：JSON格式確保大綱結構清晰
3. **進度可視化**：用戶知道生成進度，不會焦慮等待
4. **更可控**：可以調整每個章節的生成參數
5. **容錯性**：如果某章節失敗，可以重試該章節

## 使用方式

1. **重啟後端**：
   ```bash
   cd backend
   python main.py
   ```

2. **前端已自動更新**：
   - 瀏覽器會自動刷新
   - 如果沒有，手動刷新 (F5)

3. **測試流程**：
   - 填寫表單生成大綱
   - 查看結構化的大綱顯示
   - 點擊"確認大綱，逐章生成教材"
   - 觀察進度條和章節狀態更新
   - 等待全部完成後查看教材

## 技術細節

- **進度追蹤**：使用內存字典存儲（簡單但有效）
- **輪詢頻率**：每秒查詢一次進度
- **超時處理**：前端會在完成或錯誤時停止輪詢
- **備用方案**：如果JSON解析失敗，自動回退到原方法
- **模型**：使用 `gpt-oss-120b`（最新的可用模型）

## 注意事項

1. 生成時間會比之前更長（因為要調用多次AI）
2. 進度追蹤使用內存存儲，服務器重啟後會丟失
3. 如果網絡不穩定，可能看到進度跳躍
4. 建議每個章節保持在2-4個主題，避免內容過長

## 後續優化建議

1. 使用 WebSocket 替代輪詢，實現真正的實時更新
2. 將進度存儲到數據庫，支持斷點續傳
3. 添加章節內容預覽功能
4. 支持重新生成單個章節
5. 添加生成日誌和錯誤詳情

