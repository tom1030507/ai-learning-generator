# 數學公式格式修正 - 強化版

## 問題

AI 仍然在生成錯誤的公式格式：

```
錯誤：[ v = \frac{3\ \text{km}}{15\ \text{min}} = 0.2\ \text{km/min} ]
錯誤：[ 5\ \frac{\text{m}}{\text{s}}\times... ]
```

## 原因

雖然 prompt 中有說明不要使用 `[ ]`，但：
- 說明不夠明顯
- 沒有提供正確和錯誤的對比範例
- AI 可能習慣使用 LaTeX 的 `\[ \]` 格式

## 解決方案

### 強化 Prompt

在教材內容和練習題的 prompt 中，明確標示：

```python
4. **【重要】數學公式格式規範**：
   - ✅ 正確：行內公式用單個 $ 符號，例如 $v = \frac{d}{t}$
   - ✅ 正確：塊級公式用雙 $$ 符號，例如 $$E = mc^2$$
   - ❌ 錯誤：絕對不要使用方括號 [ ] 包裹公式
   - ❌ 錯誤：不要寫成 [ v = \frac{d}{t} ]
   - 範例：計算速率時寫 $v = \frac{30\text{ km}}{2\text{ h}} = 15\text{ km/h}$
```

### 關鍵改進

1. **【重要】標記** - 突出這是關鍵要求
2. **✅ ❌ 符號** - 視覺化正確和錯誤
3. **具體範例** - 提供實際的正確寫法
4. **明確禁止** - "絕對不要"、"不要寫成"

## 正確格式對照

### 行內公式

**❌ 錯誤：**
```
[ v = \frac{3\ \text{km}}{15\ \text{min}} = 0.2\ \text{km/min} ]
```

**✅ 正確：**
```
$v = \frac{3\text{ km}}{15\text{ min}} = 0.2\text{ km/min}$
```

**顯示效果：** *v = 3km/15min = 0.2km/min*

---

### 單位換算公式

**❌ 錯誤：**
```
[ 5\ \frac{\text{m}}{\text{s}}\times\frac{3600\ \text{s}}{1\ \text{h}}\times\frac{1\ \text{km}}{1000\ \text{m}} = 18\ \text{km/h} ]
```

**✅ 正確：**
```
$5\frac{\text{m}}{\text{s}} \times \frac{3600\text{ s}}{1\text{ h}} \times \frac{1\text{ km}}{1000\text{ m}} = 18\text{ km/h}$
```

或使用塊級公式：
```
$$
5\frac{\text{m}}{\text{s}} \times \frac{3600\text{ s}}{1\text{ h}} \times \frac{1\text{ km}}{1000\text{ m}} = 18\text{ km/h}
$$
```

---

### 簡單公式

**❌ 錯誤：**
```
[ a = b + c ]
```

**✅ 正確：**
```
$a = b + c$
```

---

### 塊級公式（居中大型）

**❌ 錯誤：**
```
\[
v = \frac{d}{t}
\]
```

**✅ 正確：**
```
$$
v = \frac{d}{t}
$$
```

## LaTeX 格式說明

### 在 Markdown 中使用 LaTeX

| 格式 | 語法 | 用途 | 範例 |
|------|------|------|------|
| 行內公式 | `$...$` | 文字中的公式 | 速率公式是 $v = \frac{d}{t}$ |
| 塊級公式 | `$$...$$` | 獨立居中的公式 | $$E = mc^2$$ |

### 常見錯誤格式

| 錯誤格式 | 說明 | 為什麼錯誤 |
|----------|------|------------|
| `[ ... ]` | LaTeX 顯示模式 | Markdown 不支援，react-markdown 無法解析 |
| `\[ ... \]` | LaTeX 顯示模式 | 同上 |
| `\( ... \)` | LaTeX 行內模式 | Markdown 不支援 |

## Prompt 改進對比

### 之前
```
4. 數學公式請使用標準 LaTeX 格式：
   - 行內公式用 $公式$
   - 塊級公式用 $$公式$$
   - 不要使用 [ ] 包裹公式
```
- 說明較簡略
- 沒有視覺標記
- 缺少具體範例

### 現在
```
4. **【重要】數學公式格式規範**：
   - ✅ 正確：行內公式用單個 $ 符號，例如 $v = \frac{d}{t}$
   - ✅ 正確：塊級公式用雙 $$ 符號，例如 $$E = mc^2$$
   - ❌ 錯誤：絕對不要使用方括號 [ ] 包裹公式
   - ❌ 錯誤：不要寫成 [ v = \frac{d}{t} ]
   - 範例：計算速率時寫 $v = \frac{30\text{ km}}{2\text{ h}} = 15\text{ km/h}$
```
- **【重要】** 標記突出
- ✅ ❌ 視覺化標記
- 具體的正確和錯誤範例
- 完整的使用範例

## 測試建議

### 1. 重新生成教材
重啟後端後，生成新的數學或物理教材，檢查公式格式。

### 2. 檢查點
- [ ] 所有公式使用 `$...$` 或 `$$...$$`
- [ ] 沒有 `[ ]` 格式的公式
- [ ] 公式可以正確渲染
- [ ] 單位使用 `\text{}` 包裹

### 3. 常見科目測試
- 數學：一元二次方程式
- 物理：速率與速度
- 化學：化學反應式

## 如果問題仍然存在

### 方案 1: 後處理替換
在後端返回內容前，自動替換：
```python
import re
content = re.sub(r'\[\s*(.+?)\s*\]', r'$\1$', content)
```

### 方案 2: 增加範例到 Prompt
在 prompt 最後加入：
```
請注意：所有公式必須使用 $ 符號，例如：
正確：小明的速率是 $v = \frac{100\text{ m}}{20\text{ s}} = 5\text{ m/s}$
錯誤：小明的速率是 [ v = \frac{100\text{ m}}{20\text{ s}} = 5\text{ m/s} ]
```

### 方案 3: 使用系統提示
如果 API 支援，在 system message 中強調：
```python
messages=[
    {"role": "system", "content": "你是教材生成助手。數學公式必須使用 $ 符號，絕對不要使用方括號 [ ]。"},
    {"role": "user", "content": prompt}
]
```

## 預期效果

**重啟後端後，新生成的教材應該：**
- ✅ 所有公式使用 `$...$` 格式
- ✅ 公式正確渲染為數學符號
- ✅ 不再出現 `[ ]` 格式

---

**重啟後端，讓新的 prompt 生效，然後重新生成教材測試！** 🔢

